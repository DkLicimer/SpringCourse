import{a as l,q as n,L as o,C as i}from"./index-f21f5de6.js";import{u as p}from"./store-97c65fef.js";const s=l(),h=p(),c=n("zakaz",{state:()=>({lvData:[],dvData:{},deliveryTimeData:[],optDvData:{items:{}},ppDvData:{items:{}},showBaseModal:!1,showOptModal:!1,showPpModal:!1,showModalOplati:!1,pageCount:0,itemsCount:0,searchAndSort:{sortName:"id",sortOrder:"down",page:1,isArchive:!1},optInput:{},ppInput:{},amount:0,orderId:"",description:"Оплата заказа"}),getters:{tableHeader:t=>[{label:"№",name:"id",orederName:"id",type:"char",width:"60px"},{label:"День",name:"dateLabel",orederName:"date",type:"char",width:"100px"},{label:"Клиент",name:"klientFioLabel",orederName:"klient__fio",type:"char",width:"100px"},{label:"Дата рождения",name:"dataRozhdeniaLabel",orederName:"klient__data_rozhdenia",type:"date",width:"100px"},{label:"Телефон",name:"klientPhone",orederName:"klient__phone",type:"char",width:"100px"},{label:"Адрес",name:"address",orederName:"address",type:"char",width:"100px"},{label:"Время доставки",name:"vremiaLabel",orederName:"vremia_label",type:"char",width:"100px"},{label:"Блюда",name:"bludaTitle",type:"char",width:"100px"},{label:"Опт",name:"isOpt",type:"bool",width:"100px"},{label:"Примечание",name:"primechanie",orederName:"primechanie",type:"char",width:"120px"},{label:"Статус",name:"statusLabel",orederName:"status",type:"char",width:"100px"},{label:"Онлайн оплата",name:"statusOplatiLabel",type:"bool",width:"100px"}],zakazTableHeader:t=>[{label:"Фото",name:"photo",type:"img",width:"30px"},{label:"Название",name:"nazvanie",orederName:"nazvanie",type:"char",width:"150px"}],searchList:t=>[{type:"text",label:"ФИО",model:"term"},{type:"text",label:"Телефон",model:"phone"},{type:"text",label:"Адрес",model:"address"},{type:"date",label:"Дата с",model:"date_from"},{type:"date",label:"Дата по",model:"date_by"},{type:"select",label:"Статус",model:"status",items:t.statusList,itemTitle:"name",itemVaile:"id"},{type:"select",label:"ОПТ заказ",model:"isOpt",items:s.yesNoNullList,itemTitle:"name",itemVaile:"id"},{type:"select",label:"Архивность",model:"isArchive",items:s.yesNoList,itemTitle:"name",itemVaile:"id"}],baseModalTitle:t=>{var a,e;return(a=t.dvData)!=null&&a.id?`Заказ № ${(e=t.dvData)==null?void 0:e.id}`:"Новый заказ"},statusList:()=>[{id:1,name:"Новый"},{id:2,name:"Исполнен"},{id:3,name:"Отменен"}],optSumItogo:t=>{let a=0;for(var e in t.optDvData.items)t.optDvData.items[e].bludo!==void 0&&t.optDvData.items[e].count!==void 0&&(a+=t.optDvData.items[e].bludo.stoimost*t.optDvData.items[e].count);return a},ppSumItogo:t=>{let a=0;for(var e in t.ppDvData.items)t.ppDvData.items[e].nabor!==void 0&&t.ppDvData.items[e].count!==void 0&&(a+=t.ppDvData.items[e].nabor.stoimost*t.ppDvData.items[e].count);return a}},actions:{changOptZakaz(t,a,e){const r=`${a}--${t.id}`,d=e.target.value>0?e.target.value:0;this.optDvData.items[r]={bludo:t,date:a,count:Number(d)}},incOptZakaz(t,a){const e=`${a}--${t.id}`;this.optDvData.items[e]===void 0?this.optDvData.items[e]={bludo:t,date:a,count:1}:this.optDvData.items[e].count+=1,this.optInput[e]=this.optDvData.items[e].count},decOptZakaz(t,a){const e=`${a}--${t.id}`;this.optDvData.items[e]===void 0?this.optDvData.items[e]={bludo:t,date:a,count:0}:this.optDvData.items[e].count=this.optDvData.items[e].count>0?this.optDvData.items[e].count-1:0,this.optInput[e]=this.optDvData.items[e].count},changPpZakaz(t,a,e){const r=`${a}--${t.id}`,d=e.target.value>0?e.target.value:0;this.ppDvData.items[r]={nabor:t,date:a,count:Number(d)}},incPpZakaz(t,a){const e=`${a}--${t.id}`;this.ppDvData.items[e]===void 0?this.ppDvData.items[e]={nabor:t,date:a,count:1}:this.ppDvData.items[e].count+=1,this.ppInput[e]=this.ppDvData.items[e].count},decPpZakaz(t,a){const e=`${a}--${t.id}`;this.ppDvData.items[e]===void 0?this.ppDvData.items[e]={nabor:t,date:a,count:0}:this.ppDvData.items[e].count=this.ppDvData.items[e].count>0?this.ppDvData.items[e].count-1:0,this.ppInput[e]=this.ppDvData.items[e].count},async getLvData(){s.modalLoad=!0;const t=await fetch(o.urls.zakaz+"/get",{method:"post",body:JSON.stringify(this.searchAndSort),headers:i.getHeader()});if(t.status===200){const a=await t.json();this.lvData=a.data,this.pageCount=a.pageCount,this.itemsCount=a.itemsCount}else s.showAlertError("Ошибка. Подробности в консоли или в логах");s.modalLoad=!1},async getDvData(t){s.modalLoad=!0;const a=await fetch(o.urls.zakaz+"/get",{method:"post",body:JSON.stringify({id:t}),headers:i.getHeader()});if(a.status===200){const e=await a.json();this.dvData=e.data}else s.showAlertError("Ошибка. Подробности в консоли или в логах");s.modalLoad=!1},async save(){if(!this.dvData.address||!this.dvData.klient&&!this.dvData.klientFio||!this.dvData.date)return s.showAlertError("Заполните поля со звездочкой (*)"),!1;s.modalLoad=!0,(await fetch(o.urls.zakaz+"/save",{method:"post",body:JSON.stringify(this.dvData),headers:i.getHeader()})).status===200?(this.getLvData(),h.getDvData(this.dvData.klient),this.showBaseModal=!1,s.showAlertInfo("Готово")):s.showAlertError("Ошибка. Подробности в консоли или в логах"),s.modalLoad=!1},async saveOpt(){if(!this.optDvData.address||!this.optDvData.klient||!this.optDvData.phone||!this.optDvData.email)return s.showAlertError("Заполните поля со звездочкой (*)"),!1;if(!this.optSumItogo>0)return s.showAlertError("Вы ничего не выбрали из блюд"),!1;s.modalLoad=!0,(await fetch(o.urls.zakaz+"/save_opt",{method:"post",body:JSON.stringify(this.optDvData),headers:i.getHeader()})).status===200?(s.showModalInfo('<div class="mb-4">Спасибо за заказ!</div><div> Менеджер с Вами свяжется</div>'),this.showOptModal=!1,this.optDvData={items:{}},this.optInput={}):s.showAlertError("Ошибка. Попробуйте ещё раз или свяжитесь с поддержкой по номеру +7 (924) 375-05-73"),s.modalLoad=!1},async savePp(){if(!this.ppDvData.address||!this.ppDvData.klient||!this.ppDvData.phone||!this.ppDvData.email)return s.showAlertError("Заполните поля со звездочкой (*)"),!1;if(!this.ppSumItogo>0)return s.showAlertError("Вы ничего не выбрали из блюд"),!1;s.modalLoad=!0;const t=await fetch(o.urls.zakaz+"/save_pp",{method:"post",body:JSON.stringify(this.ppDvData),headers:i.getHeader()});if(t.status===200){s.showModalInfo('<div class="mb-4">Спасибо за заказ!</div><div> Менеджер с Вами свяжется</div>'),this.showPpModal=!1,this.ppInput={};const a=await t.json();return s.modalLoad=!1,a}else s.showAlertError("Ошибка. Попробуйте ещё раз или свяжитесь с поддержкой по номеру +7 (924) 375-05-73");s.modalLoad=!1},async openBaseModal(t=null){t?await this.getDvData(t):this.dvData={status:1,date:new Date().toISOString().slice(0,10),bluda:{}},this.showBaseModal=!0},async openModalOplati(){this.showModalOplati=!0},async openOptModal(t=null){this.showOptModal=!0},async openPpModal(t=null){this.showPpModal=!0},reseatSearch(){this.searchAndSort={sortName:"id",sortOrder:"down",isArchive:!1},this.getLvData()},async updateSort(t){this.searchAndSort.sortName===t?this.searchAndSort.sortOrder==="up"?this.searchAndSort.sortOrder="down":(this.searchAndSort.sortName="id",this.searchAndSort.sortOrder="up"):(this.searchAndSort.sortName=t,this.searchAndSort.sortOrder="up"),this.getLvData()},async getAll(){this.searchAndSort.page=1,this.searchAndSort.showAll=!0,this.getLvData()},async delete(t){s.modalLoad=!0,(await fetch(o.urls.zakaz+"/delete",{method:"post",body:JSON.stringify({id:t}),headers:i.getHeader()})).status===200?(this.getLvData(),this.showBaseModal=!1,s.showAlertInfo("Готово")):s.showAlertError("Ошибка. Подробности в консоли или в логах"),s.modalLoad=!1},async printZakaz(){s.modalLoad=!0;const t=await fetch(o.urls.report+"/zakaz",{method:"post",body:JSON.stringify(this.searchAndSort),headers:i.getHeader()});t.status===200?open(t.url):s.showAlertError("Ошибка. Подробности в консоли или в логах"),s.modalLoad=!1},async createPayment(){const t=await this.savePp(),a=this.ppSumItogo,e="https://example.com/success/";if(t.id){const r=await fetch(o.urls.tinkoff+"/post",{method:"post",body:JSON.stringify({amount:a,orderId:t.id,callbackUrl:e,zakaz:t.zakaz,email:t.email,phone:t.phone}),headers:i.getHeader()});if(r.status===200){this.showModalOplati=!1;const d=await r.json();window.location.href=d.PaymentURL,await this.getStatus(d)}else alert("Ошибка инициализации платежа");this.showModalOplati=!1,s.modalLoad=!1}},async getStatus(t){(await fetch(o.urls.tinkoff+"/get_status",{method:"post",body:JSON.stringify({paymentId:t.PaymentId}),headers:i.getHeader()})).status===200?console.log("Успешная оплата"):alert("Ошибка инициализации платежа"),this.showModalOplati=!1,s.modalLoad=!1},async getDeliveryTime(){s.modalLoad=!0;const t=await fetch(o.urls.zakaz+"/get_delivery_time",{method:"post",body:JSON.stringify(),headers:i.getHeader()});if(t.status===200){const a=await t.json();this.deliveryTimeData=a.data}else s.showAlertError("Ошибка. Подробности в консоли или в логах");s.modalLoad=!1}}});export{c as u};
