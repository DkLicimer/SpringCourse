# Внутренняя документация проекта "ZabGU SPACE"

## 1. Введение

Этот документ описывает архитектуру, ключевые модули и принципы работы веб-приложения "ZabGU SPACE". Он предназначен для разработчиков, которые будут поддерживать и дорабатывать проект.

## 2. Архитектура

Проект построен на основе классической трехслойной архитектуры:

1.  **Controller Layer (`/controller`)**: Отвечает за прием HTTP-запросов, их валидацию и передачу данных в сервисный слой. В проекте разделены публичные контроллеры, PageController для отдачи HTML-страниц и защищенные контроллеры для административной панели.
2.  **Service Layer (`/service`)**: Содержит всю бизнес-логику приложения. Например, `ApplicationService` обрабатывает логику создания, одобрения и отклонения заявок, а также отправку email. Сервисы транзакционны.
3.  **Repository Layer (`/repository`)**: Отвечает за взаимодействие с базой данных. Реализован с помощью Spring Data JPA, что позволяет избегать написания шаблонного SQL-кода.

### Безопасность
Аутентификация администраторов реализована с помощью **JSON Web Tokens (JWT)**.
- **Процесс входа:** Администратор отправляет логин и пароль на эндпоинт `/api/auth/login`. Spring Security проверяет данные. В случае успеха `JwtTokenProvider` генерирует токен доступа.
- **Доступ к защищенным ресурсам:** Клиент (фронтенд) должен прикреплять полученный JWT в заголовок `Authorization: Bearer <token>` ко всем запросам к защищенным API (например, `/api/admin/**`).
- **Фильтрация:** `JwtAuthFilter` перехватывает каждый запрос, проверяет наличие и валидность токена и, если он корректен, устанавливает аутентификацию в контексте безопасности Spring.

### База данных
Используется **PostgreSQL**. Схема базы данных управляется с помощью инструмента миграций **Flyway**.
- Все миграции находятся в `src/main/resources/db/migration`.
- Для добавления новой миграции необходимо создать файл `V<Номер>__<Описание>.sql`. Flyway автоматически применит его при следующем запуске приложения.

## 3. Описание ключевых модулей

### `entity`
- **Application**: Основная сущность, представляющая заявку на бронирование.
- **Room**: Сущность помещения.
- **Employee**: Сущность сотрудника-администратора.
- **ApplicationStatus**: Enum для статусов заявки (`PENDING`, `APPROVED`, `REJECTED`).

### `dto` (Data Transfer Object)
Используются для строгого определения данных, которыми обмениваются клиент и сервер.
- **`request`**: DTO для входящих запросов (например, `CreateApplicationRequest` с правилами валидации).
- **`response`**: DTO для исходящих ответов (например, `ApplicationDetailsResponse`, чтобы не отправлять на клиент лишние данные из сущности).

### `service`
- **ApplicationService**: Логика работы с заявками. Важные методы: `createApplication`, `approveApplication`, `rejectApplication`.
- **RoomService**: Логика CRUD-операций для помещений.
- **FileStorageService**: Отвечает за загрузку, сохранение и удаление изображений помещений.
- **EmailService**: Асинхронная отправка email-уведомлений.

## 4. Ключевые точки API (Endpoints)

### Публичные
- `GET /api/rooms`: Получить список всех помещений.
- `GET /api/rooms/{id}`: Получить детальную информацию о помещении.
- `GET /api/rooms/{id}/schedule`: Получить расписание (одобренные заявки) для помещения на заданный период.
- `POST /api/applications`: Создать новую заявку на бронирование.

### Аутентификация
- `POST /api/auth/login`: Вход для администратора, получение JWT.

### Админ-панель (требуют JWT)
- `GET /api/admin/applications`: Получить список заявок с пагинацией и фильтрацией по статусу.
- `POST /api/admin/applications/{id}/approve`: Одобрить заявку.
- `POST /api/admin/applications/{id}/reject`: Отклонить заявку.
- `POST /api/admin/applications/{id}/cancel`: Отменить уже одобренную бронь.
- `GET /api/admin/analytics`: Получить данные для страницы аналитики.
- `POST /api/admin/rooms`: Создать новое помещение (с загрузкой файла).
- `PUT /api/admin/rooms/{id}`: Обновить данные о помещении.
- `DELETE /api/admin/rooms/{id}`: Удалить помещение.

## 5. Конфигурация

- **`application.properties`**: (Содержимое не предоставлено, но должно включать) настройки подключения к БД, настройки почтового сервера, секретный ключ и время жизни JWT.
- **`docker-compose.yaml`**: Переменные окружения для подключения к БД передаются из этого файла напрямую в контейнер с приложением.
- **`WebConfig.java`**: Настройка CORS и, что важно, настройка раздачи статических файлов. Загруженные пользователем изображения из папки, указанной в `file.upload-dir`, становятся доступны по URL `/uploads/**`.

## 6. Как...
### ...сгенерировать хеш нового пароля для администратора?
Для этого существует утилитарный класс `PasswordGenerator.java`. Просто измените пароль в переменной `rawPassword` и запустите его `main` метод. Результат из консоли можно будет вставить в SQL-миграцию.

### ...добавить новую зависимость?
Добавьте соответствующий блок `<dependency>` в файл `pom.xml` и перезапустите сборку проекта (`docker-compose build app` или `docker-compose up --build`).